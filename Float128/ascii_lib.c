#include <stdlib.h> // malloc() и free()
#include <stdint.h> // size_t
#include <unistd.h> // write()

//
// Количество цифр в разных числах:
// 2^32			10
// 2^64			20
// 2^128		39
// 2^256		78
// 2^512		155
// 2^1024		309
// 2^2048		617
// 2^4096		1234
//
// Такими будут затраты памяти на представление в ASCII
//

struct ascii_vec {
	// Неизменный указатель на выделенную память
	void* memory;

	// Изменяемые указатели для просмотра числа
	char* lsc; // Least significant char
	char* msc; // Most significant char
};

typedef struct ascii_vec av_t;

av_t av_new(size_t size) {
	av_t av;

	char* memory = malloc(size);

	for (size_t i = 0; i < size; i++)
		memory[i] = '0';

	av.memory = memory;
	av.msc = memory;
	av.lsc = memory + size - 1;

	return av;
}

av_t av_from_string(char* str) {
	av_t av;

	av.msc = str;
	av.lsc = str + strlen(str) - 1;

	return av;
}

void print_av(av_t* av) {
	size_t len = av->lsc - av->msc + 1;
	write(1, av->msc, len);
}

// c = a + b
av_t ascii_add(av_t* a, av_t* b) {
	size_t size_a = (a->lsc - a->msc);
	size_t size_b = (b->lsc - b->msc);

	// Сравнить размеры исходных чисел и выделить память с небольшим запасом
	size_t max = size_a;

	if (size_b > max)
		max = size_b;

	av_t result = av_new(max + 2);

	char* src_a = a->lsc;
	char* src_b = b->lsc;
	char* dst = result.lsc;


	// Первый проход: два источника
	size_t lim = 0;

	if (size_a > size_b) {
		lim = size_b;
	} else {
		lim = size_a;
	}

	char cf = 0;

	for (size_t i = 0; i <= lim; i++) {
		char va = *src_a;
		char vb = *src_b;

		unsigned char rs = 150 + cf + va + vb;

		if (rs < 150) {
			*dst = rs + '0';
			cf = 1;
		} else {
			*dst = rs - 150 - '0';
			cf = 0;
		}

		src_a--;
		src_b--;
		dst--;
	}


	// Второй проход нужен только если было различие в размерах
	if (size_a != size_b) {
		// Второй проход: один источник
		char* src;

		if (lim >= size_b) {
			lim = size_a - lim;
			src = src_a;
		} else {
			lim = size_b - lim;
			src = src_b;
		}

		for (size_t i = 0; i < lim; i++) {
			char va = *src;

			unsigned char rs = 150 + cf + va + '0';

			if (rs < 150) {
				*dst = rs + '0';
				cf = 1;
			} else {
				*dst = rs - 150 - '0';
				cf = 0;
			}

			src--;
			dst--;
		}
	}

	// Редкий особый случай: 9999 + 1
	if (cf) {
		*dst = '1';
	}

	// Скрыть ведущий ноль
	if (*result.msc == '0')
		result.msc++;

	return result;
}

// Обёртка, которая автоматически высвободит память
av_t ascii_add_autofree(av_t* a, av_t* b) {
	av_t result = ascii_add(a, b);

	if (a->memory == b->memory) {
		free(a->memory);

		a->memory = NULL;
	} else {
		free(a->memory);
		free(b->memory);

		a->memory = NULL;
		b->memory = NULL;
	}

	return result;
}

/*
// 12345 + 123457 = 135802
void test_a() {
	av_t a =  av_from_string("9999");
	av_t b = av_from_string("1");

	av_t c = ascii_add(&a, &b);

	print_av(&a);
	printf("\n");
	print_av(&b);
	printf("\n");
	print_av(&c);
	printf("\n");
}


// Большие числа
// 2^16384 + 2^16385
// Последние цифры: 2200448
void test_b() {
	time_t start = time(0);

	av_t a;
	av_t b;
	av_t c;

	for (int i = 0; i < 1048576; i++) {
		a = av_from_string("1189731495357231765085759326628007130763444687096510237472674821233261358180483686904488595472612039915115437484839309258897667381308687426274524698341565006080871634366004897522143251619531446845952345709482135847036647464830984784714280967845614138476044338404886122905286855313236158695999885790106357018120815363320780964323712757164290613406875202417365323950267880089067517372270610835647545755780793431622213451903817859630690311343850657539360649645193283178291767658965405285113556134369793281725888015908414675289832538063419234888599898980623114025121674472051872439321323198402942705341366951274739014593816898288994445173400364617928377138074411345791848573595077170437644191743889644885377684738322240608239079061399475675334739784016491742621485229014847672335977897158397334226349734811441653077758250988926030894789604676153104257260141806823027588003441951455327701598071281589597169413965608439504983171255062282026626200048042149808200002060993433681237623857880627479727072877482838438705048034164633337013385405998040701908662387301605018188262573723766279240798931717708807901740265407930976419648877869604017517691938687988088008944251258826969688364194133945780157844364946052713655454906327187428531895100278695119323496808703630436193927592692344820812834297364478686862064169042458555136532055050508189891866846863799917647547291371573500701015197559097453040033031520683518216494195636696077748110598284901343611469214274121810495077979275556645164983850062051066517084647369464036640569339464837172183352956873912042640003611618789278195710052094562761306703551840330110645101995435167626688669627763820604342480357906415354212732946756073006907088870496125050068156659252761297664065498347492661798824062312210409274584565587264846417650160123175874034726261957289081466197651553830744424709698634753627770356227126145052549125229448040149114795681359875968512808575244271871455454084894986155020794806980939215658055319165641681105966454159951476908583129721503298816585142073061480888021769818338417129396878371459575846052583142928447249703698548125295775920936450022651427249949580708203966082847550921891152133321048011973883636577825533325988852156325439335021315312134081390451021255363707903495916963125924201167877190108935255914539488216897117943269373608639074472792751116715127106396425081353553137213552890539802602978645319795100976432939091924660228878912900654210118287298298707382159717184569540515403029173307292454391789568674219640761451173600617752186991913366837033887201582071625868247133104513315097274713442728340606642890406496636104443217752811227470029162858093727701049646499540220983981932786613204254226464243689610107429923197638681545837561773535568984536053627234424277105760924864023781629665526314910906960488073475217005121136311870439925762508666032566213750416695719919674223210606724721373471234021613540712188239909701971943944347480314217903886317767779921539892177334344368907550318800833546852344370327089284147501640589448482001254237386680074457341910933774891959681016516069106149905572425810895586938833067490204900368624166301968553005687040285095450484840073528643826570403767157286512380255109954518857013476588189300004138849715883139866071547574816476727635116435462804401112711392529180570794193422686818353212799068972247697191474268157912195973794192807298886952361100880264258801320928040011928153970801130741339550003299015924978259936974358726286143980520112454369271114083747919007803406596321353417004068869443405472140675963640997405009225803505672726465095506267339268892424364561897661906898424186770491035344080399248327097911712881140170384182058601614758284200750183500329358499691864066590539660709069537381601887679046657759654588001937117771344698326428792622894338016112445533539447087462049763409147542099248815521395929388007711172017894897793706604273480985161028815458787911160979113422433557549170905442026397275695283207305331845419990749347810524006194197200591652147867193696254337864981603833146354201700628817947177518115217674352016511172347727727075220056177748218928597158346744541337107358427757919660562583883823262178961691787226118865632764934288772405859754877759869235530653929937901193611669007472354746360764601872442031379944139824366828698790212922996174192728625891720057612509349100482545964152046477925114446500732164109099345259799455690095576788686397487061948854749024863607921857834205793797188834779656273479112388585706424836379072355410286787018527401653934219888361061949671961055068686961468019035629749424086587195041004404915266476272761070511568387063401264136517237211409916458796347624949215904533937210937520465798300175408017538862312719042361037129338896586028150046596078872444365564480545689033575955702988396719744528212984142578483954005084264327730840985420021409069485412320805268520094146798876110414583170390473982488899228091818213934288295679717369943152460447027290669964066816");
		b = av_from_string("2379462990714463530171518653256014261526889374193020474945349642466522716360967373808977190945224079830230874969678618517795334762617374852549049396683130012161743268732009795044286503239062893691904691418964271694073294929661969569428561935691228276952088676809772245810573710626472317391999771580212714036241630726641561928647425514328581226813750404834730647900535760178135034744541221671295091511561586863244426903807635719261380622687701315078721299290386566356583535317930810570227112268739586563451776031816829350579665076126838469777199797961246228050243348944103744878642646396805885410682733902549478029187633796577988890346800729235856754276148822691583697147190154340875288383487779289770755369476644481216478158122798951350669479568032983485242970458029695344671955794316794668452699469622883306155516501977852061789579209352306208514520283613646055176006883902910655403196142563179194338827931216879009966342510124564053252400096084299616400004121986867362475247715761254959454145754965676877410096068329266674026770811996081403817324774603210036376525147447532558481597863435417615803480530815861952839297755739208035035383877375976176017888502517653939376728388267891560315688729892105427310909812654374857063790200557390238646993617407260872387855185384689641625668594728957373724128338084917110273064110101016379783733693727599835295094582743147001402030395118194906080066063041367036432988391273392155496221196569802687222938428548243620990155958551113290329967700124102133034169294738928073281138678929674344366705913747824085280007223237578556391420104189125522613407103680660221290203990870335253377339255527641208684960715812830708425465893512146013814177740992250100136313318505522595328130996694985323597648124624420818549169131174529692835300320246351748069452523914578162932395303107661488849419397269507255540712454252290105098250458896080298229591362719751937025617150488543742910908169789972310041589613961878431316110638331283362211932908319902953817166259443006597633170284146122961776043539636676834258793756742919151692105166285856894499407397096250591551841872900045302854499899161416407932165695101843782304266642096023947767273155651066651977704312650878670042630624268162780902042510727415806991833926251848402335754380217870511829078976433794235886538747217278148945585502233430254212792850162707106274427105781079605205957290639590201952865878183849320457757825801308420236574596597414764319434369139081030806058346614584908783579137348439281522902347201235504373983826733674067774403164143251736494266209026630194549426885456681213285780812993272208886435505622454940058325716187455402099292999080441967963865573226408508452928487379220214859846395277363091675123547071137969072107254468848554211521849728047563259331052629821813920976146950434010242272623740879851525017332065132427500833391439839348446421213449442746942468043227081424376479819403943887888694960628435807772635535559843079784354668688737815100637601667093704688740654178568295003281178896964002508474773360148914683821867549783919362033032138212299811144851621791173877666134980409800737248332603937106011374080570190900969680147057287653140807534314573024760510219909037714026953176378600008277699431766279732143095149632953455270232870925608802225422785058361141588386845373636706425598137944495394382948536315824391947588385614597773904722201760528517602641856080023856307941602261482679100006598031849956519873948717452572287961040224908738542228167495838015606813192642706834008137738886810944281351927281994810018451607011345452930191012534678537784848729123795323813796848373540982070688160798496654195823425762280340768364117203229516568401500367000658716999383728133181079321418139074763203775358093315519309176003874235542689396652857585245788676032224891067078894174924099526818295084198497631042791858776015422344035789795587413208546961970322057630917575822321958226844867115098341810884052794551390566414610663690839981498695621048012388394401183304295734387392508675729963207666292708403401257635894355036230435348704033022344695455454150440112355496437857194316693489082674214716855515839321125167767646524357923383574452237731265529868577544811719509755519738471061307859875802387223338014944709492721529203744884062759888279648733657397580425845992348385457251783440115225018698200965091928304092955850228893001464328218198690519598911380191153577372794974123897709498049727215843715668411587594377669559312546958224777171412849672758144710820573574037054803307868439776722123899343922110137373922936038071259498848173174390082008809830532952545522141023136774126802528273034474422819832917592695249898431809067874421875040931596600350816035077724625438084722074258677793172056300093192157744888731128961091378067151911405976793439489056425968285156967908010168528655461681970840042818138970824641610537040188293597752220829166340780947964977798456183636427868576591359434739886304920894054581339928133632");

		c = ascii_add(&a, &b);
	}

	time_t end = time(0);

	print_av(&a);
	printf("\n");
	print_av(&b);
	printf("\n");
	print_av(&c);
	printf("\n");

	printf("Took me %llu seconds\n", end - start);
}

void test_c() {
	av_t base = av_from_string("2");

	for (int i = 0; i < 128; i++) {
		printf("2^%d: ", i + 1);
		print_av(&base);
		printf("\n");

		base = ascii_add(&base, &base);
	}
}
*/
